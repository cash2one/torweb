function monitor_system_status(){$.ajax({type:"get",dataType:"json",url:"/api/systemstatus",success:function(e,t){if(0==e.errorcode){var e=e.data;$(".cpu-per").html(e.cpu_per+"%"),$(".ram-per").html(e.ram_per+"%"),$(".net-conn").html(e.net_conn),$(".os-start").html(e.os_start)}}}),setTimeout(monitor_system_status,6e4)}function change_theme(){$(".color").on("click",function(e){var t=$(e.target).attr("color");$.cookie("theme",t,{expires:30}),$.ajax({type:"post",dataType:"json",url:"/useropt",data:JSON.stringify({opt:"update-theme",data:{theme:t}}),success:function(e,t){0==e.errorcode?$.notify("主题保存成功"):e.errorcode==-3&&$("#loginModal").modal("toggle")}}),$("#theme").attr("href","/assets/css/index."+t+".css")})}function set_theme(){var e=$.cookie("theme");e&&$("#theme").attr("href","/assets/css/index."+e+".css")}function change_image_preview(){$inputFileElm=$(this);var e=document.getElementById("avatar-cropper"),t=document.getElementById("avatar-file"),a=t.value.substring(t.value.lastIndexOf(".")+1).toLowerCase();if("png"!=a&&"jpg"!=a&&"jpeg"!=a)return void alert("文件必须为图片！");if(t.size>3072e3)return void alert("上传图片不要超过3000KB");if(document.all){t.select();var r=document.selection.createRange().text,o=/msie 6/i.test(navigator.userAgent);o?e.src=r:(e.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod='image',src=\""+r+'")',e.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==")}else{var s=t.files[0],n=new FileReader;n.readAsDataURL(s),n.onload=function(t){e.src=t.target.result,$(e).cropper("reset").cropper("replace",t.target.result)}}$inputFileElm.val("")}function html5Reader(e){var t=e.files[0],a=new FileReader;a.readAsDataURL(t),a.onload=function(e){var t=document.getElementById("avatar-cropper");t.src=this.result}}function show_hide_cate_nav(){$(".card-header-all-bt, .card-header:after").mouseenter(function(e){$(".card-header-all").fadeIn(500)}),$(".card-header-all").parent().mouseleave(function(e){$(".card-header-all").css("display","none")}),$(".all-cate-card .card-block").mouseenter(function(e){$(".card-header-all").css("display","none")})}function post_new_show_hide_cate(){$(".post-new-html #topic").on("click",function(e){$(".card-header-all").css("display","block")}),$(".post-new-html .card-header-all-cate a").on("click",function(e){$(".card-header-all").css("display","none"),$("#topic").val($(this).html())})}function show_hide_emoji_list(){$("#emoji-btn").on("mousedown",function(e){$("#summernote").summernote("saveRange")}).on("click",function(e){e.preventDefault(),e.stopPropagation(),$("#emoji-list").css("display","block")})}function show_hide_emoji_list_medium(){$("#emoji-btn").on("click",function(e){e.preventDefault(),e.stopPropagation(),$("#emoji-list").css("display","block")})}function add_action_emoji_img_medium(){$("#emoji-list img.emoji").on("click",function(e){var t=$("#mediumeditor");t.append('<img src="'+e.target.src+'" class="emoji">')})}function add_action_emoji_char_medium(){$("#emoji-list li.emoji").on("click",function(e){var t=$("#mediumeditor");t.append('<span class="emoji">'+window.emojiJSON[e.target.attributes.em.value].char+"</span>")})}function load_emoji_medium(){for(var e=["smile","blush","grin","heart_eyes","relaxed","sweat_smile","joy","flushed","confused","unamused","sob","cold_sweat","sweat","scream","sleepy","mask"],t=0;t<e.length;t++)$("#emoji-list").append('<img class="emoji" src="/assets/images/emoji/basic/'+e[t]+'.png">');add_action_emoji_img_medium(),$.getJSON("/assets/images/emoji/emojis.json",function(e){window.emojiJSON=e,$("#emoji-list").append('<li class="emoji" em="heart">'+emojiJSON.heart.char+"</li>"),add_action_emoji_char_medium()})}function load_font_avatar(){var e=["#FF5722","#CDDC39","#61C5FF","#2196F3"];$(".post-avatar a span").each(function(t,a){var r=e[Math.floor(Math.random()*e.length)];$(a).css("background-color",r)})}function getFriendlyTime(e){if(e=e.replace("-","/"),e=e.replace("-","/"),!e)return"biu...";var t=Date.now()-Date.parse(e),a=6e4,r=36e5,o=864e5,s=6048e5,n=2592e6,i=31536e6;return t<2*a?"A moment ago":t<r?Math.floor(t/a)+" mins ago":t<o?1==Math.floor(t/r)?"an hour ago":Math.floor(t/r)+" hrs ago":t<s?1==Math.floor(t/o)?"yesterday":Math.floor(t/o)+" days ago":t<n?1==Math.floor(t/s)?"last week":Math.floor(t/s)+" weeks ago":t<i?1==Math.floor(t/n)?"last month":Math.floor(t/n)+" months ago":1==Math.floor(t/i)?"an year ago":Math.floor(t/i)+" yrs ago"}function replate_friendly_time(){$(".friendly-time").each(function(e,t){$(t).html(getFriendlyTime($(t).html()))})}function extractDomain(e){var t;return t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0]}function get_websocket_url(e){$.ajax({type:"get",dataType:"json",url:"/api/websocketurl",success:function(t){if(0==t.errorcode){var a=t.data.url;"."==a&&(a=extractDomain(window.location.href)),e(a),console.log("get websocket url success. and start websocket.")}else 0!=t.errorcode&&console.log("get websocket url error.")}})}function start_system_monitor_websocket(e){function t(e){console.log("Connected to WebSocket server.")}function a(e){console.log("Disconnected")}function r(e){var t=JSON.parse(e.data).data;$(".cpu-per").html(t.cpu_per+"%"),$(".ram-per").html(t.ram_per+"%"),$(".net-conn").html(t.net_conn),$(".os-start").html(t.os_start)}function o(e){console.log("Error occured: "+e.data)}var s="ws://"+e+"/api/systemstatuswebsocket";sys_websocket=new WebSocket(s),sys_websocket.onopen=function(e){t(e)},sys_websocket.onclose=function(e){a(e)},sys_websocket.onmessage=function(e){r(e)},sys_websocket.onerror=function(e){o(e)}}function start_chat_websocket(e){function t(e){console.log("Connected to WebSocket server."),send_socket_message("update_recent_user_list","")}function a(e){console.log("Disconnected")}function r(e){var t=JSON.parse(e.data);console.log(t),0==t.errorcode&&handle_receive_message(t.data)}function o(e){console.log("Error occured: "+e.data)}var s="ws://"+e+"/user/chatwebsocket";chat_websocket=new WebSocket(s),chat_websocket.onopen=function(e){t(e)},chat_websocket.onclose=function(e){a(e)},chat_websocket.onmessage=function(e){r(e)},chat_websocket.onerror=function(e){o(e)}}function send_socket_message(e,t){""==t&&(t="x");var a=JSON.stringify({opt:e,data:t});chat_websocket.send(a)}function set_current_user(e){window.sessionStorage.setItem("current_user_id",e)}function is_current_user(e){var t=window.sessionStorage.getItem("current_user_id");return!(!t||t!=e)}function is_current_user_list(e){var t=window.sessionStorage.getItem("recent_user_list");if(!t)return!1;t=JSON.parse(t);var a=t.user_id_list;return!(!a||a.indexOf(e)==-1)}function append_message_to_chat_content(e){if("<"==e[0])var t="<li class='chat-other cl'><img class='avatar' src='/assets/images/avatar/"+$(".chat .chat-header").attr("other_avatar")+"'><div class='chat-text'>"+e[1]+"</div></li>";else var t="<li class='chat-self cl'><img class='avatar' src='/assets/images/avatar/"+$(".chat .chat-header").attr("me_avatar")+"'><div class='chat-text'>"+e[1]+"</div></li>";$(".chat .chat-content ul").append(t)}function append_tmp_user_to_user_list(e,t,a){$(".chat-user-all").append("<div class='chat-user' other='"+e+"'><img class='chat-user-avatar' src='/assets/images/avatar/"+a+"'><span class='chat-user-name'>"+t+"</span></div>"),$(".chat-user").on("click",function(e){var t=$(e.currentTarget).attr("other");set_current_user(t),send_socket_message("recent_chat_message",{user_id:t})})}function generate_chat_user_list(){var e=window.sessionStorage.getItem("recent_user_list");if(!e)return void send_socket_message("update_recent_user_list","");e=JSON.parse(e),$(".chat-user-all").html("");for(var t=0;t<e.user_id_list.length;t++){var a=e.user_id_list[t],r=e[a].other_id,o=e[a].other_avatar,s=e[a].other_name;$(".chat-user-all").append("<div class='chat-user' other='"+r+"'><img class='chat-user-avatar' src='/assets/images/avatar/"+o+"'><span class='chat-user-name'>"+s+"</span></div>")}$(".chat-user").on("click",function(e){var t=$(e.currentTarget).attr("other");set_current_user(t),send_socket_message("recent_chat_message",{user_id:t})})}function generate_chat_content_html(e){$(".chat .chat-title").html("chat 2 "+e.other_name),$(".chat .chat-header").attr("other_avatar",e.other_avatar),$(".chat .chat-header").attr("me_avatar",e.me_avatar),$(".chat .chat-header").attr("other_id",e.other_id);var t=e.msg;$(".chat .chat-content ul").html("");for(var a=0;a<t.length;a++){if("<"==t[a][0])var r="<li class='chat-other cl'><img class='avatar' src='/assets/images/avatar/"+e.other_avatar+"'><div class='chat-text'>"+t[a][1]+"</div></li>";else var r="<li class='chat-self cl'><img class='avatar' src='/assets/images/avatar/"+e.me_avatar+"'><div class='chat-text'>"+t[a][1]+"</div></li>";$(".chat .chat-content ul").append(r)}$(".chat-container").show()}function handle_receive_message(e){"update_recent_user_list"==e.code?(window.sessionStorage.setItem("recent_user_list",JSON.stringify(e)),generate_chat_user_list()):"update_recent_user_list_and_open"==e.code?(window.sessionStorage.setItem("recent_user_list",JSON.stringify(e)),generate_chat_user_list(),$(".chat-container").show()):"receive_message"==e.code?is_current_user(e.other_id)?append_message_to_chat_content(e.msg):send_socket_message("update_recent_user_list",""):"recent_chat_message"==e.code&&(generate_chat_content_html(e),is_current_user_list(e.other_id)||append_tmp_user_to_user_list(e.other_id,e.other_name,e.other_avatar))}function get_message_cache_from_server(e,t){$.ajax({type:"post",dataType:"json",url:"/useropt",data:JSON.stringify({opt:"realtime-chat",data:{other:e}}),success:function(a,r){if(0==a.errorcode){var o=a.data;window.sessionStorage.setItem(e,JSON.stringify(o)),t(o)}else{if(a.errorcode==-3)return $.notify(a.txt),!1;if(0!=a.errorcode)return $.notify(a.txt),!1}}})}$(document).on("mouseover",".dropdown",function(){$(this).find(".dropdown-menu").show()}),$(document).on("mouseout",".dropdown",function(){$(this).find(".dropdown-menu").hide()}),$(".upload-avatar").on("click",function(e){e.preventDefault();var t=$("#avatar-cropper").cropper("getCroppedCanvas",{width:200,height:200}).toDataURL();$.ajax({type:"post",dataType:"json",url:"/useropt",data:JSON.stringify({opt:"update-avatar",data:{avatar:t.split(",")[1]}}),success:function(e,t){0==e.errorcode?($.notify("头像更换成功"),window.location.reload()):1==e.errorcode&&alert(e.txt)}})});var $this,$ajaxUrl="";$.fn.pasteUploadImage=function(e){$this=$(this),$host=e,$this.on("paste",function(e){console.log("paste...");var t,a,r,o;if(r=e.originalEvent,r.clipboardData&&r.clipboardData.items&&(a=isImage(r)))return e.preventDefault(),t=getFilename(r)||"image.png",o="{{"+t+"(uploading...)}}",pasteText(o),uploadFile(a.getAsFile(),t)}),$this.on("drop",function(e){console.log("drop...");var t,a,r,o;if(r=e.originalEvent,r.dataTransfer&&r.dataTransfer.files&&(a=isImageForDrop(r)))return e.preventDefault(),t=r.dataTransfer.files[0].name||"image.png",o="{{"+t+"(uploading...)}}",pasteText(o),uploadFile(a,t)})},pasteText=function(e){var t,a,r,o,s;return o=$this[0].selectionStart,r=$this[0].selectionEnd,s=$this.val().length,a=$this.val().substring(0,o),t=$this.val().substring(r,s),$this.val(a+e+t),$this.get(0).setSelectionRange(o+e.length,r+e.length),$this.trigger("input")},isImage=function(e){var t,a;for(t=0;t<e.clipboardData.items.length;){if(a=e.clipboardData.items[t],a.type.indexOf("image")!==-1)return a;t++}return!1},isImageForDrop=function(e){var t,a;for(t=0;t<e.dataTransfer.files.length;){if(a=e.dataTransfer.files[t],a.type.indexOf("image")!==-1)return a;t++}return!1},getFilename=function(e){var t;return window.clipboardData&&window.clipboardData.getData?t=window.clipboardData.getData("Text"):e.clipboardData&&e.clipboardData.getData&&(t=e.clipboardData.getData("text/plain")),t=t.split("\r"),t[0]},getMimeType=function(e,t){var a=e.type,r=t.substring(t.lastIndexOf(".")+1);return a!="image/"+r?"image/"+r:a},uploadFile=function(e,t){var a=new FormData;a.append("imageFile",e),a.append("mimeType",getMimeType(e,t)),$.ajax({url:$ajaxUrl,data:a,type:"post",processData:!1,contentType:!1,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){return e.success?insertToTextArea(t,e.message):replaceLoadingTest(t)},error:function(e,a){replaceLoadingTest(t),console.log(e.responseText)}})},insertToTextArea=function(e,t){return $this.val(function(a,r){return r.replace("{{"+e+"(uploading...)}}","!["+e+"]("+t+")\n")})},replaceLoadingTest=function(e){return $this.val(function(t,a){return a.replace("{{"+e+"(uploading...)}}",e+"\n")})},$('#loginModal [type="submit"]').on("click",function(e){return e.preventDefault(),$.ajax({type:"post",dataType:"json",url:"/login",data:{username:$("#loginModal #username").val(),password:$("#loginModal #password").val(),captcha:$("#loginModal #captcha").val()},success:function(e,t){if(0==e.errorcode){e.data;$.notify("登陆成功"),window.location.reload()}else e.errorcode==-3?($.notify(e.txt),$("#captcha").val("")):0!=e.errorcode&&$.notify(e.txt)}}),1}),$(".captcha").on("click",function(e){e.preventDefault();var t=$(e.currentTarget).attr("src"),a=t.indexOf("?");a!=-1&&(t=t.substring(0,a)),t=t+"?id="+Math.random(1).toString(),$(e.currentTarget).attr("src",t)}),$(".real-time-chat").on("click",function(){$(".no-recent-user-list").show(),send_socket_message("update_recent_user_list_and_open","")}),$(document).click(function(e){$(".chat-container").is(":hidden")||$("#emoji-list").is(":hidden")||$("#emoji-list").hide()}),$(document).ready(function(){$(".chat-close").on("click",function(e){$(".chat-container").hide()}),change_theme(),load_font_avatar()});